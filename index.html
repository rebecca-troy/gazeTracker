<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gaze Tracker with Calibration</title>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      overflow: hidden;
      background: #fafafa;
    }
    #gaze-dot {
      position: absolute;
      width: 20px;
      height: 20px;
      background: red;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10;
    }
    .calibration-point {
      position: absolute;
      width: 30px;
      height: 30px;
      background: blue;
      border-radius: 50%;
      opacity: 0.7;
      cursor: pointer;
      z-index: 100;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: black;
      color: white;
      padding: 10px 15px;
      z-index: 200;
    }
  </style>
</head>
<body>
  <div id="status">Loading camera...</div>
  <div id="gaze-dot"></div>

  <script>
    const dot = document.getElementById('gaze-dot');
    const status = document.getElementById('status');

    const calibrationPoints = [
      { x: '10%', y: '10%' },
      { x: '90%', y: '10%' },
      { x: '50%', y: '50%' },
      { x: '10%', y: '90%' },
      { x: '90%', y: '90%' }
    ];

    let calibrationDone = 0;

    function createCalibrationPoint(x, y) {
      const point = document.createElement('div');
      point.className = 'calibration-point';
      point.style.left = x;
      point.style.top = y;
      point.addEventListener('click', () => {
        // Train 5 times on the same spot
        const rect = point.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        for (let i = 0; i < 5; i++) {
          webgazer.recordScreenPosition(centerX, centerY, 'click');
        }

        point.remove();
        calibrationDone++;
        if (calibrationDone === calibrationPoints.length) {
          status.textContent = "Calibration done! Gaze tracking active.";
        }
      });
      document.body.appendChild(point);
    }

    async function startWebGazer() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        status.textContent = "Starting WebGazer...";

        await webgazer.setRegression('ridge')
                      .setTracker('clmtrackr')
                      .setGazeListener((data) => {
                        if (data) {
                          dot.style.left = `${data.x}px`;
                          dot.style.top = `${data.y}px`;
                          console.log(`Gaze at: ${Math.round(data.x)}, ${Math.round(data.y)}`);
                        }
                      })
                      .begin();

        webgazer.showVideo(false)
                .showPredictionPoints(false)
                .showFaceOverlay(false);

        // Give time for WebGazer to initialize
        setTimeout(() => {
          status.textContent = "Click each blue dot to calibrate.";
          calibrationPoints.forEach(pt => createCalibrationPoint(pt.x, pt.y));
        }, 1000);

      } catch (err) {
        status.textContent = "Camera access denied or error.";
        console.error(err);
      }
    }

    startWebGazer();

    window.addEventListener('beforeunload', () => {
      webgazer.end();
    });
  </script>
</body>
</html>
