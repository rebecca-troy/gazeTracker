<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Improved Gaze Tracker</title>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      overflow: hidden;
      background: #fafafa;
    }
    #gaze-dot {
      position: absolute;
      width: 20px;
      height: 20px;
      background: red;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10;
    }
    .calibration-point {
      position: absolute;
      width: 30px;
      height: 30px;
      background: blue;
      border-radius: 50%;
      opacity: 0.7;
      cursor: pointer;
      z-index: 100;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: black;
      color: white;
      padding: 10px 15px;
      z-index: 200;
    }
  </style>
</head>
<body>
  <div id="status">Loading camera...</div>
  <div id="gaze-dot"></div>

  <script>
    const dot = document.getElementById('gaze-dot');
    const status = document.getElementById('status');
    const calibrationClicksRequired = 5;
    const clickCounts = {};
    let calibrationIndex = 0;
    const recentPoints = [];

    function createCalibrationPointAt(x, y, index) {
      const point = document.createElement('div');
      point.className = 'calibration-point';
      point.style.left = `${x}px`;
      point.style.top = `${y}px`;
      point.dataset.index = index;
      clickCounts[index] = 0;

      point.addEventListener('click', () => {
        webgazer.recordScreenPosition(x, y, 'click');
        clickCounts[index]++;
        point.style.opacity = `${0.7 * ((calibrationClicksRequired - clickCounts[index]) / calibrationClicksRequired)}`;

        if (clickCounts[index] >= calibrationClicksRequired) {
          point.remove();
          calibrationIndex++;
          if (calibrationIndex >= 9) {
            status.textContent = "✅ Calibration complete. Gaze tracking active.";
          }
        }
      });

      document.body.appendChild(point);
    }

    function placeCalibrationGrid() {
      const gridRows = 3;
      const gridCols = 3;
      const spacingX = window.innerWidth / (gridCols + 1);
      const spacingY = window.innerHeight / (gridRows + 1);

      for (let row = 1; row <= gridRows; row++) {
        for (let col = 1; col <= gridCols; col++) {
          const x = spacingX * col;
          const y = spacingY * row;
          createCalibrationPointAt(x, y, (row - 1) * gridCols + (col - 1));
        }
      }
    }

    async function startWebGazer() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        status.textContent = "Starting WebGazer...";

        await webgazer.setRegression('ridge')
                      .setTracker('clmtrackr')
                      .setGazeListener((data) => {
                        if (!data) return;

                        recentPoints.push(data);
                        if (recentPoints.length > 10) recentPoints.shift();

                        const avg = recentPoints.reduce((acc, pt) => {
                          acc.x += pt.x;
                          acc.y += pt.y;
                          return acc;
                        }, { x: 0, y: 0 });

                        const avgX = avg.x / recentPoints.length;
                        const avgY = avg.y / recentPoints.length;

                        dot.style.left = `${avgX}px`;
                        dot.style.top = `${avgY}px`;
                      })
                      .begin();

        webgazer.showVideo(false)
                .showPredictionPoints(false)
                .showFaceOverlay(false);

        setTimeout(() => {
          status.textContent = "Click each blue dot 5 times to calibrate.";
          placeCalibrationGrid();
        }, 1000);

      } catch (err) {
        status.textContent = "❌ Camera error: " + err.message;
        console.error(err);
      }
    }

    startWebGazer();

    window.addEventListener('beforeunload', () => {
      webgazer.end();
    });
  </script>
</body>
</html>
