<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Improved Gaze Tracker</title>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      overflow: hidden;
      background: #fafafa;
    }
    #gaze-dot {
      position: absolute;
      width: 12px;
      height: 12px;
      background: rgba(255, 0, 0, 0.6);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10;
      transition: left 0.05s linear, top 0.05s linear;
    }
    .calibration-point {
      position: absolute;
      width: 30px;
      height: 30px;
      background: blue;
      border-radius: 50%;
      opacity: 0.7;
      cursor: pointer;
      z-index: 100;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: black;
      color: white;
      padding: 10px 15px;
      z-index: 200;
    }
    #recalibrate {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #333;
      color: white;
      padding: 10px 15px;
      cursor: pointer;
      z-index: 200;
    }
  </style>
</head>
<body>
  <div id="status">Loading camera...</div>
  <div id="recalibrate">ðŸ”„ Recalibrate</div>
  <div id="gaze-dot"></div>

  <script>
    const dot = document.getElementById('gaze-dot');
    const status = document.getElementById('status');
    const recalibrateBtn = document.getElementById('recalibrate');
    const calibrationClicksRequired = 5;
    const clickCounts = {};
    let calibrationIndex = 0;
    let smoothed = { x: null, y: null };
    const smoothingFactor = 0.15;

    function createCalibrationPointAt(x, y, index) {
      const point = document.createElement('div');
      point.className = 'calibration-point';
      point.style.left = `${x}px`;
      point.style.top = `${y}px`;
      point.dataset.index = index;
      clickCounts[index] = 0;

      point.addEventListener('click', () => {
        webgazer.recordScreenPosition(x, y, 'click');
        clickCounts[index]++;
        point.style.opacity = `${0.7 * ((calibrationClicksRequired - clickCounts[index]) / calibrationClicksRequired)}`;

        if (clickCounts[index] >= calibrationClicksRequired) {
          point.remove();
          calibrationIndex++;
          if (calibrationIndex >= 9) {
            status.textContent = "âœ… Calibration complete. Stabilizing...";
            setTimeout(() => {
              status.textContent = "âœ… Gaze tracking active.";
            }, 2000);
          }
        }
      });

      document.body.appendChild(point);
    }

    function placeCalibrationGrid() {
      calibrationIndex = 0;
      Object.keys(clickCounts).forEach(key => delete clickCounts[key]);

      const existing = document.querySelectorAll('.calibration-point');
      existing.forEach(p => p.remove());

      const gridRows = 3;
      const gridCols = 3;
      const spacingX = window.innerWidth / (gridCols + 1);
      const spacingY = window.innerHeight / (gridRows + 1);

      for (let row = 1; row <= gridRows; row++) {
        for (let col = 1; col <= gridCols; col++) {
          const x = spacingX * col;
          const y = spacingY * row;
          createCalibrationPointAt(x, y, (row - 1) * gridCols + (col - 1));
        }
      }
    }

    async function startWebGazer() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        status.textContent = "Starting WebGazer...";

        await webgazer.setRegression('ridge')
                      .setTracker('clmtrackr')
                      .setGazeListener((data) => {
                        if (!data) return;

                        if (smoothed.x === null || smoothed.y === null) {
                          smoothed.x = data.x;
                          smoothed.y = data.y;
                        } else {
                          smoothed.x += (data.x - smoothed.x) * smoothingFactor;
                          smoothed.y += (data.y - smoothed.y) * smoothingFactor;
                        }

                        dot.style.left = `${smoothed.x}px`;
                        dot.style.top = `${smoothed.y}px`;
                      })
                      .begin();

        webgazer.showVideo(true)
                .showPredictionPoints(false)
                .showFaceOverlay(false)
                .saveDataAcrossSessions(true);

        setTimeout(() => {
          status.textContent = "Click each blue dot 5 times to calibrate.";
          placeCalibrationGrid();
        }, 1000);

      } catch (err) {
        status.textContent = "âŒ Camera error: " + err.message;
        console.error(err);
      }
    }

    startWebGazer();

    recalibrateBtn.addEventListener('click', () => {
      status.textContent = "ðŸ”„ Recalibration started. Click blue dots.";
      placeCalibrationGrid();
    });

    window.addEventListener('beforeunload', () => {
      webgazer.end();
    });
  </script>
</body>
</html>
