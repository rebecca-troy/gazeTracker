<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Accurate Eye Tracker (Step 1)</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <style>
    video, canvas {
      position: absolute;
      top: 0;
      left: 0;
      transform: scaleX(-1); /* mirror webcam */
    }
    #debug {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      background: black;
      color: white;
      font-family: sans-serif;
      z-index: 10;
    }
  </style>
</head>
<body>
  <video class="input_video" autoplay muted playsinline></video>
  <canvas class="output_canvas"></canvas>
  <div id="debug">Initializing...</div>

  <script>
    const video = document.querySelector('.input_video');
    const canvas = document.querySelector('.output_canvas');
    const ctx = canvas.getContext('2d');
    const debug = document.getElementById('debug');

    const faceMesh = new FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${file}`
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });

    faceMesh.onResults(onResults);

    const camera = new Camera(video, {
      onFrame: async () => await faceMesh.send({ image: video }),
      width: 640,
      height: 480
    });
    camera.start();

    function drawLandmark(pt, color = 'cyan', size = 4) {
      ctx.beginPath();
      ctx.arc(pt.x * canvas.width, pt.y * canvas.height, size, 0, 2 * Math.PI);
      ctx.fillStyle = color;
      ctx.fill();
    }

    function onResults(results) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      if (!results.multiFaceLandmarks.length) {
        debug.textContent = 'No face detected';
        return;
      }

      const lm = results.multiFaceLandmarks[0];
      const iris = lm[468]; // center of left eye
      const leftCorner = lm[33];
      const rightCorner = lm[133];
      const topLid = lm[159];
      const bottomLid = lm[145];
      const nose = lm[1]; // head stabilization ref

      drawLandmark(iris, 'red');
      drawLandmark(leftCorner, 'blue');
      drawLandmark(rightCorner, 'blue');
      drawLandmark(topLid, 'green');
      drawLandmark(bottomLid, 'green');
      drawLandmark(nose, 'yellow');

      debug.textContent = `Tracking iris. Head angle ref: nose (${nose.x.toFixed(3)}, ${nose.y.toFixed(3)})`;
    }
  </script>
</body>
</html>
