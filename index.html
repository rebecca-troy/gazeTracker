<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Improved Gaze Tracker</title>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      overflow: hidden;
      background: #fafafa;
    }
    #gaze-dot {
      position: absolute;
      width: 20px;
      height: 20px;
      background: red;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10;
    }
    .calibration-point {
      position: absolute;
      width: 30px;
      height: 30px;
      background: blue;
      border-radius: 50%;
      opacity: 0.7;
      cursor: pointer;
      z-index: 100;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: black;
      color: white;
      padding: 10px 15px;
      z-index: 200;
    }
  </style>
</head>
<body>
  <div id="status">Loading camera...</div>
  <div id="gaze-dot"></div>

  <script>
    const dot = document.getElementById('gaze-dot');
    const status = document.getElementById('status');

    const calibrationClicksRequired = 5;
    let calibrationIndex = 0;
    let clickCounts = {};

    const recentPoints = [];

    const calibrationPoints = [];
    for (let y of [10, 50, 90]) {
      for (let x of [10, 50, 90]) {
        calibrationPoints.push({ x, y });
      }
    }

    function createCalibrationPoint(xPercent, yPercent, index) {
      const point = document.createElement('div');
      point.className = 'calibration-point';

      const x = window.innerWidth * (xPercent / 100);
      const y = window.innerHeight * (yPercent / 100);

      point.style.left = `${x}px`;
      point.style.top = `${y}px`;

      point.dataset.index = index;
      clickCounts[index] = 0;

      point.addEventListener('click', () => {
        const rect = point.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        for (let i = 0; i < 1; i++) {
          webgazer.recordScreenPosition(centerX, centerY, 'click');
        }

        clickCounts[index]++;
        point.style.opacity = `${0.7 * ((calibrationClicksRequired - clickCounts[index]) / calibrationClicksRequired)}`;

        if (clickCounts[index] >= calibrationClicksRequired) {
          point.remove();
          calibrationIndex++;
          if (calibrationIndex >= calibrationPoints.length) {
            status.textContent = "✅ Calibration complete. Gaze tracking active.";
          }
        }
      });

      document.body.appendChild(point);
    }

    async function startWebGazer() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        status.textContent = "Starting WebGazer...";

        await webgazer.setRegression('ridge')
                      .setTracker('clmtrackr')
                      .setGazeListener((data) => {
                        if (!data) return;

                        // Apply smoothing (moving average)
                        recentPoints.push(data);
                        if (recentPoints.length > 10) recentPoints.shift();

                        const avg = recentPoints.reduce((acc, pt) => {
                          acc.x += pt.x;
                          acc.y += pt.y;
                          return acc;
                        }, { x: 0, y: 0 });

                        const avgX = avg.x / recentPoints.length;
                        const avgY = avg.y / recentPoints.length;

                        dot.style.left = `${avgX}px`;
                        dot.style.top = `${avgY}px`;
                      })
                      .begin();

        webgazer.showVideo(false)
                .showPredictionPoints(false)
                .showFaceOverlay(false);

        setTimeout(() => {
          status.textContent = "Click each blue dot 5 times to calibrate.";
          calibrationPoints.forEach((pt, idx) =>
            createCalibrationPoint(pt.x, pt.y, idx)
          );
        }, 1000);

      } catch (err) {
        status.textContent = "❌ Camera error: " + err.message;
        console.error(err);
      }
    }

    startWebGazer();

    window.addEventListener('beforeunload', () => {
      webgazer.end();
    });
  </script>
</body>
</html>
